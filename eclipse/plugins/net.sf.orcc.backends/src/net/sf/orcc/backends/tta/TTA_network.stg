

network(network, options) ::= <<
-------------------------------------------------------------------------------
-- Title      : Network: <network.name>
-- Project    : 
-------------------------------------------------------------------------------
-- File       : <network.name>.vhd
-- Author     : Orcc - TTA
-- Company    : 
-- Created    : 
-- Standard   : VHDL'93
-------------------------------------------------------------------------------
-- Copyright (c)  
-------------------------------------------------------------------------------
-- Revisions  :
-- Date        Version  Author  Description
-- 
-------------------------------------------------------------------------------


------------------------------------------------------------------------------
library ieee;
use ieee.std_logic_1164.all;

library work;

------------------------------------------------------------------------------
entity top is
  port
    (
      clk : in  std_logic;
      <ports(network)>
      reset_n  : in  std_logic
      );
end top;

------------------------------------------------------------------------------
architecture bdf_type of top is

  ---------------------------------------------------------------------------
  -- Signals declaration
  ---------------------------------------------------------------------------  
  <signals(network)>
  ---------------------------------------------------------------------------
  
begin

  ---------------------------------------------------------------------------
  -- Ports instantiation 
  ---------------------------------------------------------------------------
  <assignNetworkPorts(network)>
  ---------------------------------------------------------------------------
  -- FIFOs instantiation 
  --------------------------------------------------------------------------- 
  <assignFifos(network.connections)>
  ---------------------------------------------------------------------------
  -- Actors instantiation 
  ---------------------------------------------------------------------------
  <assignInstances(network.instances)>
  ---------------------------------------------------------------------------
  


end bdf_type;

>>

///////////////////////////////////////////////////////////////////////////////
// Network ports
///////////////////////////////////////////////////////////////////////////////

ports(network) ::= <<
<if(network.inputs)><network.inputs: {port|<port(port, "in")>}; separator=";\n">;<endif>
<if(network.outputs)><network.outputs: {port|<port(port, "out")>}; separator=";\n">;<endif>
>>

port(port, dir) ::= <<
<port.name> : <dir> <if(port.type.bool)>std_logic<else>std_logic_vector(<port.type.size>-1 downto 0)<endif>
>>

///////////////////////////////////////////////////////////////////////////////
// Components
///////////////////////////////////////////////////////////////////////////////

components(network) ::= <<
<network.instances: component(); separator="\n\n">
>>

component(instance) ::= <<
<if(instance.actor)
>component processor_<instance.id>
  port(clk			: in  std_logic;
       <instance.actor.inputs: inputPort(); separator="\n">
       <instance.actor.outputs: outputPort(); separator="\n">
       reset_n		: in  std_logic
       );
end component;<
elseif(instance.broadcast)
>component processor_<instance.id>
  port(clk			: in  std_logic;
       <instance.broadcast.inputs.list: inputPort(); separator="\n">
       <instance.broadcast.outputs.list: outputPort(); separator="\n">
       reset_n		: in  std_logic
       );
end component;<
endif>
>>

inputPort(port) ::= <<
<if(port.native)
><port.name>_in				: in std_logic_vector(<port.type.size>-1 downto 0);<
else
>data_<indexPort(port)>_in		: in  std_logic_vector(31 downto 0);
status_<indexPort(port)>_in	: in  std_logic_vector(31 downto 0);
ack_<indexPort(port)>_in		: out std_logic;<
endif>
>>

outputPort(port) ::= <<
<if(port.native)
><port.name>_out		: out std_logic_vector(<port.type.size>-1 downto 0);<
else
>data_<indexPort(port)>_out		: out std_logic_vector(31 downto 0);
status_<indexPort(port)>_out	: in  std_logic_vector(31 downto 0);
dv_<indexPort(port)>_out		: out std_logic;<
endif>
>>

indexPort(port) ::= <<
<if(instance.actor)
><instance.actor.templateData.portToIndexMap.(port)><
elseif(instance.broadcast)
><instance.broadcast.portMap.(port)><
endif>
>>


///////////////////////////////////////////////////////////////////////////////
// Signals
///////////////////////////////////////////////////////////////////////////////

signals(network) ::= <<
<network.instances: { instance | <instanceSignals(instance, network.incomingMap.(instance), network.outgoingMap.(instance))> }; separator="\n\n">
>>

instanceSignals(instance, incomingMap, outgoingMap) ::= <<
-- Instance: <instance.id> 
<incomingMap.keys: { port | <inputPortSignals(port, incomingMap.(port))> }; separator="\n">
<outgoingMap.keys: { port | <outputPortSignals(port, first(outgoingMap.(port)))> }; separator="\n">
>>

inputPortSignals(port, connection) ::= <<
---- Input port: <port.name>
<if(!port.native)
>signal fifo_<indexConnection(connection)>_wrreq		: std_logic;
signal fifo_<indexConnection(connection)>_data		: std_logic_vector(31 downto 0) := (others =\> '0');<
elseif(!connection.source)
>signal s_<indexConnection(connection)> 		: std_logic_vector(<port.type.size>-1 downto 0);<
endif>
>>

outputPortSignals(port, connection) ::= <<
---- Output port: <port.name>
<if(!port.native)
>signal fifo_<indexConnection(connection)>_rdreq		: std_logic;
signal fifo_<indexConnection(connection)>_q			: std_logic_vector(31 downto 0) := (others =\> '0');
signal fifo_<indexConnection(connection)>_status		: std_logic_vector(31 downto 0);<
else
>signal s_<indexConnection(connection)> 		: std_logic_vector(<port.type.size>-1 downto 0);<
endif>
>>

indexConnection(connection) ::= <<
<network.connectionMap.(connection)>
>>


///////////////////////////////////////////////////////////////////////////////
// Instantiation
///////////////////////////////////////////////////////////////////////////////

assignNetworkPorts(network) ::= <<
<network.connections: assignNetworkPort()>
>>

assignNetworkPort(connection) ::= <<
<if(!connection.source)>
<network.sourceMap.(connection).port.name> \<= s_<indexConnection(connection)>;
<elseif(!connection.target)>
<network.targetMap.(connection).port.name> \<= s_<indexConnection(connection)>;
<endif>
>>

assignFifos(connections) ::= <<
<connections: assignFifo()>
>>

assignFifo(connection) ::= <<
<if(!connection.source.native && !connection.target.native)>
fifo_<indexConnection(connection)> : work.fifo
  generic map(width =\> 32)
  port map(wrreq   =\> fifo_<indexConnection(connection)>_wrreq,
           reset_n =\> reset_n,
           clk     =\> clk,
           rdreq   =\> fifo_<indexConnection(connection)>_rdreq,
           data    =\> fifo_<indexConnection(connection)>_data(31 downto 0),
           q       =\> fifo_<indexConnection(connection)>_q(31 downto 0),
           status  =\> fifo_<indexConnection(connection)>_status);
           
<endif>
>>

assignInstances(instances) ::= <<
<instances: assignInstance(); separator="\n\n">
>>

assignInstance(instance) ::= <<
<instance.id>_inst : work.<if(!instance.actor.native)>processor_<endif><instance.id>
  port map(clk          =\> clk,
           <assignPorts(instance)>
           reset_n      =\> reset_n);
>>

assignPorts(instance) ::= <<
<if(instance.actor)
><instance.actor.inputs: assignInputPort(); separator="\n">
<instance.actor.outputs: assignOutputPort(); separator="\n"><
elseif(instance.broadcast)
><instance.broadcast.inputs.list: assignInputPort(); separator="\n">
<instance.broadcast.outputs.list: assignOutputPort(); separator="\n"><
endif>
>>

assignInputPort(port) ::= <<
<if(port.native)
><port.name>   =\> s_<indexInputConnection(port)>,<
else
>data_<indexPort(port)>_in    =\> fifo_<indexInputConnection(port)>_q,
status_<indexPort(port)>_in  =\> fifo_<indexInputConnection(port)>_status,
ack_<indexPort(port)>_in     =\> fifo_<indexInputConnection(port)>_rdreq,<
endif>
>>

assignOutputPort(port) ::= <<
<if(port.native)
><port.name>   =\> s_<indexOutputConnection(port)>,<
else
>data_<indexPort(port)>_out   =\> fifo_<indexOutputConnection(port)>_data,
status_<indexPort(port)>_out =\> fifo_<indexOutputConnection(port)>_status,
dv_<indexPort(port)>_out     =\> fifo_<indexOutputConnection(port)>_wrreq,<
endif>
>>

indexInputConnection(port) ::= <<
<indexConnection(network.incomingMap.(instance).(port))>
>>

indexOutputConnection(port) ::= <<
<indexConnection(first(network.outgoingMap.(instance).(port)))>
>>
