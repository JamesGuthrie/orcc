

printDesign(design, options) ::= <<
-------------------------------------------------------------------------------
-- Title      : Network: <design.name>
-- Project    : 
-------------------------------------------------------------------------------
-- File       : <design.name>.vhd
-- Author     : Orcc - TTA
-- Company    : 
-- Created    : 
-- Standard   : VHDL'93
-------------------------------------------------------------------------------
-- Copyright (c)  
-------------------------------------------------------------------------------
-- Revisions  :
-- Date        Version  Author  Description
-- 
-------------------------------------------------------------------------------


------------------------------------------------------------------------------
library ieee;
use ieee.std_logic_1164.all;

library work;
use work.broadcast_type.all;

------------------------------------------------------------------------------
entity top is
  port
    (
      clk : in  std_logic;
      <declarePorts(design)>
      rst_n : in  std_logic
      );
end top;

------------------------------------------------------------------------------
architecture bdf_type of top is

  ---------------------------------------------------------------------------
  -- Signals declaration
  ---------------------------------------------------------------------------  
  <design.signals: declareSignal(); separator="\n">
  <design.buffers: declareBufferSignals(); separator="\n">
  ---------------------------------------------------------------------------
  
begin

  ---------------------------------------------------------------------------
  -- Ports instantiation 
  ---------------------------------------------------------------------------
  <design.inputs: { input | <assignNetworkPort(input, first(input.outgoing))> }; separator="\n">
  <design.outputs: { output | <assignNetworkPort(output, first(output.incoming))> }; separator="\n">
  ---------------------------------------------------------------------------
  -- Buffers instantiation 
  --------------------------------------------------------------------------- 
  <design.buffers: assignBuffer(); separator="\n\n">
  ---------------------------------------------------------------------------
  -- Processors instantiation 
  ---------------------------------------------------------------------------
  <design.processors: assignProcessor(); separator="\n\n">
  ---------------------------------------------------------------------------
  -- Components instantiation 
  ---------------------------------------------------------------------------
  <design.components: assignComponent(); separator="\n\n">
  ---------------------------------------------------------------------------  


end bdf_type;

>>

///////////////////////////////////////////////////////////////////////////////
// Network ports
///////////////////////////////////////////////////////////////////////////////

declarePorts(component) ::= <<
<if(design.inputs)><design.inputs: declareInput(); separator="\n"><endif>
<if(design.outputs)><design.outputs: declareOutput(); separator="\n"><endif>
>>

declareInput(port) ::= <<
<port.label> : in std_logic_vector(<port.size>-1 downto 0);
>>

declareOutput(port) ::= <<
<port.label> : out std_logic_vector(<port.size>-1 downto 0);
>>


///////////////////////////////////////////////////////////////////////////////
// Signals
///////////////////////////////////////////////////////////////////////////////

declareSignal(signal) ::= <<
signal s_<signal.label> : std_logic_vector(<signal.size>-1 downto 0);
>>

declareBufferSignals(buffer) ::= <<
signal buf_<buffer.label>_wren_p1    : std_logic;
signal buf_<buffer.label>_address_p1 : std_logic_vector(xx downto 0);
signal buf_<buffer.label>_byteen_p1  : std_logic_vector(xx downto 0);
signal buf_<buffer.label>_data_p1    : std_logic_vector(31 downto 0);
signal buf_<buffer.label>_queue_p1   : std_logic_vector(31 downto 0);
signal buf_<buffer.label>_wren_p2    : std_logic;
signal buf_<buffer.label>_address_p2 : std_logic_vector(xx downto 0);
signal buf_<buffer.label>_byteen_p2  : std_logic_vector(xx downto 0);
signal buf_<buffer.label>_data_p2    : std_logic_vector(31 downto 0);
signal buf_<buffer.label>_queue_p2   : std_logic_vector(31 downto 0);
>> 


///////////////////////////////////////////////////////////////////////////////
// Instantiation
///////////////////////////////////////////////////////////////////////////////

assignNetworkPort(port, link) ::= <<
<port.label> \<= s_<link.label>;
>>

assignInputPort(port, link) ::= <<
<if(link.signal)
><port.name> =\> s_<link.label>,<
else
>fu_LSU_buf_<port.addressSpace.id>_dmem_data_in    => buf_<link.label>_data_p2,
fu_LSU_buf_<port.addressSpace.id>_dmem_data_out   => buf_<link.label>_queue_p2,
fu_LSU_buf_<port.addressSpace.id>_dmem_addr       => buf_<link.label>_address_p2,
fu_LSU_buf_<port.addressSpace.id>_dmem_wr_en_x(0) => buf_<link.label>_wren_p2,
fu_LSU_buf_<port.addressSpace.id>_dmem_bytemask   => buf_<link.label>_byteen_p2,<
endif>
>>

assignOutputPort(port, link) ::= <<
<if(link.signal)
><port.name> =\> s_<link.label>,<
else
>fu_LSU_buf_<port.addressSpace.id>_dmem_data_in    => buf_<link.label>_data_p1,
fu_LSU_buf_<port.addressSpace.id>_dmem_data_out   => buf_<link.label>_queue_p1,
fu_LSU_buf_<port.addressSpace.id>_dmem_addr       => buf_<link.label>_address_p1,
fu_LSU_buf_<port.addressSpace.id>_dmem_wr_en_x(0) => buf_<link.label>_wren_p1,
fu_LSU_buf_<port.addressSpace.id>_dmem_bytemask   => buf_<link.label>_byteen_p1,<
endif>
>>

assignGeneric(attribute) ::= <<
<attribute.name> =\> <attribute.value>
>>

assignComponent(component) ::= <<
<component.name>_inst : entity work.<component.name>
  <if(component.attributes)>generic map(<component.attributes: assignGeneric(); separator=",\n">)<endif>
  port map(clk =\> clk,
           <component.inputs: { input |<assignInputPort(input, component.incomingPortMap.(input))>}; separator="\n">
           <component.outputs: { output |<assignOutputPort(output, component.outgoingPortMap.(output))>}; separator="\n">
           rst_n =\> rst_n);
>>

assignBuffer(buffer) ::= <<
buffer_<buffer.label> : entity work.inferredRAM_2p
  generic map(depth  =\> <buffer.depth>,
              byte_width  =\> <buffer.byte_width>,
              addr_width =\> <buffer.addr_width>,
              bytes      =\> <buffer.bytes>)
  port map(clk        =\> clk,
           wren_p1    =\> buf_<buffer.label>_wren_p1,
           address_p1 =\> buf_<buffer.label>_address_p1,
           byteen_p1  =\> buf_<buffer.label>_byteen_p1,
           data_p1    =\> buf_<buffer.label>_data_p1,
           q_p1       =\> buf_<buffer.label>_queue_p1,
           wren_p2    =\> buf_<buffer.label>_wren_p2,
           address_p2 =\> buf_<buffer.label>_address_p2,
           byteen_p2  =\> buf_<buffer.label>_byteen_p2,
           data_p2    =\> buf_<buffer.label>_data_p2,
           q_p2       =\> buf_<buffer.label>_queue_p2,
           rst_n      =\> rst_n);
>>

assignProcessor(processor) ::= <<
<processor.name>_inst : entity work.<processor.name>
  generic map(device_family =\> "<options.fpga.family>")
  port map(clk                          =\> clk,
           <processor.incoming: { edge |<assignInputPort(edge.targetPort, edge)>}; separator="\n">
           <processor.outgoing: { edge |<assignOutputPort(edge.sourcePort, edge)>}; separator="\n">
           rst_n                        =\> rst_n);
>>
