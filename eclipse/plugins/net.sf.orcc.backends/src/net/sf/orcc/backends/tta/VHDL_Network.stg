

printNetwork(network, options) ::= <<
-------------------------------------------------------------------------------
-- Title      : Network: <network.name>
-- Project    : 
-------------------------------------------------------------------------------
-- File       : <network.name>.vhd
-- Author     : Orcc - TTA
-- Company    : 
-- Created    : 
-- Standard   : VHDL'93
-------------------------------------------------------------------------------
-- Copyright (c)  
-------------------------------------------------------------------------------
-- Revisions  :
-- Date        Version  Author  Description
-- 
-------------------------------------------------------------------------------


------------------------------------------------------------------------------
library ieee;
use ieee.std_logic_1164.all;

library work;

------------------------------------------------------------------------------
entity top is
  port
    (
      clk      : in  std_logic;
      <ports(network)>
      rst_n    : in  std_logic
      );
end top;

------------------------------------------------------------------------------
architecture bdf_type of top is

  ---------------------------------------------------------------------------
  -- Signals declaration
  ---------------------------------------------------------------------------  
  <signals(network)>
  ---------------------------------------------------------------------------
  
begin

  ---------------------------------------------------------------------------
  -- Ports instantiation 
  ---------------------------------------------------------------------------
  <network.connections: assignNetworkPort()>
  ---------------------------------------------------------------------------
  -- FIFOs instantiation 
  --------------------------------------------------------------------------- 
  <network.connections: assignFifo()>
  ---------------------------------------------------------------------------
  -- Actors instantiation 
  ---------------------------------------------------------------------------
  <network.instances: assignInstance(); separator="\n\n">
  ---------------------------------------------------------------------------  


end bdf_type;

>>

///////////////////////////////////////////////////////////////////////////////
// Network ports
///////////////////////////////////////////////////////////////////////////////

ports(network) ::= <<
<if(network.inputs)><network.inputs: {port|<port(port, "in")>}; separator=";\n">;<endif>
<if(network.outputs)><network.outputs: {port|<port(port, "out")>}; separator=";\n">;<endif>
>>

port(port, dir) ::= <<
<port.name> : <dir> <if(port.type.bool)>std_logic<else>std_logic_vector(<port.type.size>-1 downto 0)<endif>
>>


///////////////////////////////////////////////////////////////////////////////
// Signals
///////////////////////////////////////////////////////////////////////////////

signals(network) ::= <<
<network.connections: declareFifoSignals(); separator="\n\n">
>>

declareFifoSignals(connection) ::= <<
<if(connection.sourcePort.native)
>signal s_<indexConnection(connection)> : std_logic_vector(<connection.sourcePort.type.size>-1 downto 0);<
else
>signal fifo_<indexConnection(connection)>_data		: std_logic_vector(31 downto 0);
signal fifo_<indexConnection(connection)>_q			: std_logic_vector(31 downto 0);
signal fifo_<indexConnection(connection)>_rdreq		: std_logic;
signal fifo_<indexConnection(connection)>_wrreq		: std_logic;
signal fifo_<indexConnection(connection)>_status    : std_logic_vector(31 downto 0);<
endif>
>>

indexConnection(connection) ::= <<
<connection.id>
>>


///////////////////////////////////////////////////////////////////////////////
// Instantiation
///////////////////////////////////////////////////////////////////////////////

assignNetworkPort(connection) ::= <<
<if(connection.source.port)>
<connection.source.name> \<= s_<indexConnection(connection)>;
<elseif(connection.target.port)>
<connection.target.name> \<= s_<indexConnection(connection)>;
<endif>
>>

assignFifo(connection) ::= <<
<if(!connection.sourcePort.native && !connection.targetPort.native)>
fifo_<indexConnection(connection)> : entity work.fifo
  generic map(width =\> 32)
  port map(clk     =\> clk,
           rdreq   =\> fifo_<indexConnection(connection)>_rdreq,
           data    =\> fifo_<indexConnection(connection)>_data(31 downto 0),
           q       =\> fifo_<indexConnection(connection)>_q(31 downto 0),
           status  =\> fifo_<indexConnection(connection)>_status,
           wrreq   =\> fifo_<indexConnection(connection)>_wrreq,
           rst_n     =\> rst_n);
           
<endif>
>>

assignInstance(instance) ::= <<
<instance.id>_inst : entity work.<if(!instance.actor.native)>processor_<endif><instance.id>
<if(instance.actor.native)
>  generic map(<assignGenerics(instance)>)  
<endif>
  port map(clk          =\> clk,
  	       <assignPort(instance)>
           rst_n        =\> rst_n);
>>

assignPort(instance) ::= <<
<if(instance.actor)
><instance.actor.inputs: { input | <assignInputPort(input, instance.incomingPortMap.(input), i)> }; separator="\n">
<instance.actor.outputs: { output | <assignOutputPort(output, first(instance.outgoingPortMap.(output)), i)> }; separator="\n"><
else
><instance.broadcast.inputs: { input | <assignInputPort(input, instance.broadcast.incomingPortMap.(input), i)> }; separator="\n">
<instance.broadcast.outputs: { output | <assignOutputPort(output, first(instance.broadcast.outgoingPortMap.(output)), i)> }; separator="\n"><
endif>
>>

assignGenerics(instance) ::= <<
<instance.arguments: { arg | <arg.variable.name> =\> <arg.value>}; separator=",\n              ">
>>

assignInputPort(port, connection, index) ::= <<
<if(port.native)
><port.name>   =\> s_<indexConnection(connection)>,<
else
>data_<index>_in    =\> fifo_<indexConnection(connection)>_q,
status_<index>_in  =\> fifo_<indexConnection(connection)>_status,
ack_<index>_in     =\> fifo_<indexConnection(connection)>_rdreq,<
endif>
>>

assignOutputPort(port, connection, index) ::= <<
<if(port.native)
><port.name>   =\> s_<indexConnection(connection)>,<
else
>data_<index>_out   =\> fifo_<indexConnection(connection)>_data,
status_<index>_out =\> fifo_<indexConnection(connection)>_status,
dv_<index>_out     =\> fifo_<indexConnection(connection)>_wrreq,<
endif>
>>
