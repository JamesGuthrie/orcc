

printNetwork(network, options) ::= <<
-------------------------------------------------------------------------------
-- Title      : Network: <network.name>
-- Project    : 
-------------------------------------------------------------------------------
-- File       : <network.name>.vhd
-- Author     : Orcc - TTA
-- Company    : 
-- Created    : 
-- Standard   : VHDL'93
-------------------------------------------------------------------------------
-- Copyright (c)  
-------------------------------------------------------------------------------
-- Revisions  :
-- Date        Version  Author  Description
-- 
-------------------------------------------------------------------------------


------------------------------------------------------------------------------
library ieee;
use ieee.std_logic_1164.all;

library work;

------------------------------------------------------------------------------
entity top is
  port
    (
      clk      : in  std_logic;
      <ports(network)>
      rst_n    : in  std_logic
      );
end top;

------------------------------------------------------------------------------
architecture bdf_type of top is

  ---------------------------------------------------------------------------
  -- Signals declaration
  ---------------------------------------------------------------------------  
  <signals(network)>
  ---------------------------------------------------------------------------
  
begin

  ---------------------------------------------------------------------------
  -- Ports instantiation 
  ---------------------------------------------------------------------------
  <network.connections: assignNetworkPort()>
  ---------------------------------------------------------------------------
  -- FIFOs instantiation 
  --------------------------------------------------------------------------- 
  <network.connections: assignFifo()>
  ---------------------------------------------------------------------------
  -- Actors instantiation 
  ---------------------------------------------------------------------------
  <network.instances: assignInstance(); separator="\n\n">
  ---------------------------------------------------------------------------  


end bdf_type;

>>

///////////////////////////////////////////////////////////////////////////////
// Network ports
///////////////////////////////////////////////////////////////////////////////

ports(network) ::= <<
<if(network.inputs)><network.inputs: {port|<port(port, "in")>}; separator=";\n">;<endif>
<if(network.outputs)><network.outputs: {port|<port(port, "out")>}; separator=";\n">;<endif>
>>

port(port, dir) ::= <<
<port.name> : <dir> <if(port.type.bool)>std_logic<else>std_logic_vector(<port.type.size>-1 downto 0)<endif>
>>


///////////////////////////////////////////////////////////////////////////////
// Signals
///////////////////////////////////////////////////////////////////////////////

signals(network) ::= <<
<network.connections: declareFifoSignals(); separator="\n\n">
>>

declareFifoSignals(connection) ::= <<
<if(connection.sourcePort.native)
>signal s_<connection.id> : std_logic_vector(<connection.sourcePort.type.size>-1 downto 0);<
else
>signal fifo_<connection.id>_data         : std_logic_vector(31 downto 0);
signal fifo_<connection.id>_q            : std_logic_vector(31 downto 0);
signal fifo_<connection.id>_rdreq        : std_logic;
signal fifo_<connection.id>_wrreq        : std_logic;
signal fifo_<connection.id>_nb_tokens    : std_logic_vector(31 downto 0);
signal fifo_<connection.id>_nb_freerooms : std_logic_vector(31 downto 0);<
endif>
>>


///////////////////////////////////////////////////////////////////////////////
// Instantiation
///////////////////////////////////////////////////////////////////////////////

assignNetworkPort(connection) ::= <<
<if(connection.source.port)>
<connection.source.name> \<= s_<connection.id>;
<elseif(connection.target.port)>
<connection.target.name> \<= s_<connection.id>;
<endif>
>>

assignFifo(connection) ::= <<
<if(!connection.sourcePort.native && !connection.targetPort.native)>
fifo_<connection.id> : entity work.fifo
  generic map(size          =\> <options.("fifoSize")>,
              widthu        =\> <options.("fifoWidthu")>,
              device_family =\> "<options.("fpgaFamily")>")
  port map(clk          =\> clk,
           rdreq        =\> fifo_<connection.id>_rdreq,
           data         =\> fifo_<connection.id>_data(31 downto 0),
           q            =\> fifo_<connection.id>_q(31 downto 0),
           nb_tokens    =\> fifo_<connection.id>_nb_tokens,
           nb_freerooms =\> fifo_<connection.id>_nb_freerooms,
           wrreq        =\> fifo_<connection.id>_wrreq,
           rst_n        =\> rst_n);
           
<endif>
>>

assignInstance(instance) ::= <<
<instance.id>_inst : entity work.<if(!instance.actor.native)>processor_<endif><instance.id>
<if(instance.actor.native)
>  generic map(<assignGenerics(instance)>)  
<else
>  generic map(device_family =\> "<options.("fpgaFamily")>")
<endif>
  port map(clk          =\> clk,
  	       <assignPort(instance)>
           rst_n        =\> rst_n);
>>

assignPort(instance) ::= <<
<if(instance.actor)
><instance.actor.inputs: { input | <assignInputPort(input, instance.incomingPortMap.(input), i0)> }; separator="\n">
<instance.actor.outputs: { output | <assignOutputPort(output, first(instance.outgoingPortMap.(output)), i0)> }; separator="\n"><
else
><instance.broadcast.inputs: { input | <assignInputPort(input, instance.incomingPortMap.(input), i0)> }; separator="\n">
<instance.broadcast.outputs: { output | <assignOutputPort(output, first(instance.outgoingPortMap.(output)), i0)> }; separator="\n"><
endif>
>>

assignGenerics(instance) ::= <<
<instance.arguments: { arg | <arg.variable.name> =\> <arg.value>}; separator=",\n              ">
>>

assignInputPort(port, connection, index) ::= <<
<if(port.native)
><port.name>   =\> s_<connection.id>,<
else
>data_<index>_in    =\> fifo_<connection.id>_q,
status_<index>_in  =\> fifo_<connection.id>_nb_tokens,
ack_<index>_in     =\> fifo_<connection.id>_rdreq,<
endif>
>>

assignOutputPort(port, connection, index) ::= <<
<if(port.native)
><port.name>   =\> s_<connection.id>,<
else
>data_<index>_out   =\> fifo_<connection.id>_data,
status_<index>_out =\> fifo_<connection.id>_nb_freerooms,
dv_<index>_out     =\> fifo_<connection.id>_wrreq,<
endif>
>>
